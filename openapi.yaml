openapi: 3.0.3
info:
  title: x402 Insurance API
  version: 2.2.0
  description: |
    Zero-Knowledge Proof verified insurance against x402 merchant fraud.

    ## Overview
    This API provides micropayment insurance for x402 protocol users. Agents can purchase
    insurance policies to protect against merchant failures, and submit claims with zkp proofs.

    ## What's New in v2.2.0
    - **Async Proof Generation**: Use `?async=true` on /claim to avoid timeout risk
    - **Policy Renewal**: Extend policies before expiration with /renew endpoint
    - **Agent Memory Solution**: Lookup policies by wallet address with /policies endpoint

    ## x402 Payment Protocol
    Certain endpoints require x402 payment. The payment flow:
    1. Agent makes request to protected endpoint
    2. Server responds with 402 Payment Required + payment details
    3. Agent signs payment with wallet and resubmits
    4. Server verifies payment and processes request

    ## Pricing
    - Premium: 1% of requested coverage amount
    - Coverage Range: 0.001 - 0.1 USDC (micropayments)
    - Protection Ratio: Up to 100x coverage

    ## Zero-Knowledge Proofs
    All fraud claims are verified using zkEngine (Nova/Arecibo SNARKs).
    Proofs are publicly verifiable without revealing merchant identity.

  contact:
    name: x402 Insurance Support
    url: https://github.com/coinbase/x402
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://your-domain.example.com
    description: Production server (placeholder)

tags:
  - name: discovery
    description: API discovery and schema endpoints
  - name: policies
    description: Insurance policy management
  - name: claims
    description: Fraud claim submission and verification
  - name: proofs
    description: Zero-knowledge proof verification (public)
  - name: monitoring
    description: Health checks and dashboard data

paths:
  /:
    get:
      summary: Dashboard UI
      description: Web-based dashboard showing policies, claims, and blockchain stats
      tags: [monitoring]
      responses:
        '200':
          description: HTML dashboard
          content:
            text/html:
              schema:
                type: string

  /api:
    get:
      summary: API Information
      description: Returns basic API information and available endpoints
      tags: [discovery]
      responses:
        '200':
          description: API metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiInfo'

  /api/schema:
    get:
      summary: OpenAPI Schema
      description: Returns the full OpenAPI 3.0 specification for this API
      tags: [discovery]
      responses:
        '200':
          description: OpenAPI specification
          content:
            application/json:
              schema:
                type: object
            application/yaml:
              schema:
                type: string

  /api/pricing:
    get:
      summary: Get Pricing Information
      description: Returns current pricing for insurance premiums and coverage limits
      tags: [discovery]
      responses:
        '200':
          description: Pricing information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PricingInfo'

  /health:
    get:
      summary: Health Check
      description: Returns service health status
      tags: [monitoring]
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'

  /api/dashboard:
    get:
      summary: Dashboard Data
      description: Returns live statistics, recent policies, and claims
      tags: [monitoring]
      responses:
        '200':
          description: Dashboard statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardData'

  /insure:
    post:
      summary: Create Insurance Policy
      description: |
        Create a new insurance policy. Requires x402 payment of the premium amount.

        **x402 Payment Required:**
        - Premium: percentage-based (1% of requested coverage)
        - Asset: USDC on Avalanche C-Chain
        - Network: avalanche

        **Payment Flow:**
        1. POST without payment → 402 response with payment details
        2. Sign payment with wallet
        3. POST with x402 headers → 201 policy created

      tags: [policies]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePolicyRequest'
            examples:
              micropayment:
                summary: Micropayment API protection
                value:
                  merchant_url: "https://api.example.com/data"
                  coverage_amount: 0.01
      responses:
        '201':
          description: Policy created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyResponse'
        '402':
          description: Payment Required
          headers:
            X-Payment-Required:
              schema:
                type: string
              description: x402 payment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentRequired'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /claim:
    post:
      summary: Submit Fraud Claim
      description: |
        Submit a fraud claim against a merchant failure. The service will:
        1. Verify the policy is active
        2. Generate zero-knowledge proof of fraud
        3. Verify the proof
        4. Issue USDC refund to policy holder

        **Fraud Detection:**
        Fraud is detected when HTTP response shows:
        - Status code: 503, 500, 404, or other error codes
        - Empty response body
        - Missing critical headers

        **Async Mode (NEW in v2.2.0):**
        Add `?async=true` query parameter to enable async processing:
        - Returns immediately (202 Accepted) with claim_id
        - Poll GET /claims/{claim_id} for status updates
        - Eliminates timeout risk during proof generation

      tags: [claims]
      parameters:
        - name: async
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Enable async processing (returns 202 immediately)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ClaimRequest'
            examples:
              service_unavailable:
                summary: Merchant returned 503
                value:
                  policy_id: "123e4567-e89b-12d3-a456-426614174000"
                  http_response:
                    status: 503
                    body: ""
                    headers:
                      server: "nginx"
      responses:
        '201':
          description: Claim approved and refund issued (sync mode)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimResponse'
        '202':
          description: Claim accepted for processing (async mode)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncClaimResponse'
        '400':
          description: Invalid claim or no fraud detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Proof generation or refund failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /claims/{claim_id}:
    get:
      summary: Get Claim Status
      description: |
        Retrieve the current status of a claim. Used for polling async claims.

        **Claim Statuses:**
        - `processing`: Proof generation in progress
        - `paid`: Claim approved, refund issued
        - `failed`: Claim processing failed

      tags: [claims]
      parameters:
        - name: claim_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Claim ID (UUID)
      responses:
        '200':
          description: Claim status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClaimStatusResponse'
        '404':
          description: Claim not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /policies:
    get:
      summary: Get Agent Policies
      description: |
        Retrieve all policies for a given agent wallet address.
        Solves the agent memory problem by allowing agents to lookup their policies.

        **Query Parameters:**
        - `wallet`: Required. Ethereum address of the agent

      tags: [policies]
      parameters:
        - name: wallet
          in: query
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{40}$'
          description: Agent's Ethereum wallet address
          example: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
      responses:
        '200':
          description: List of policies for the wallet
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PoliciesResponse'
        '400':
          description: Missing or invalid wallet address
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /renew:
    post:
      summary: Renew/Extend Policy
      description: |
        Extend an existing policy before expiration. Requires x402 payment.

        **Features:**
        - Extend by 1-168 hours (max 7 days)
        - Pro-rated fees: (extend_hours / 24) × original_premium
        - Same policy_id preserved
        - Cannot renew expired policies

        **x402 Payment Required:**
        - Amount: Pro-rated renewal fee
        - Asset: USDC on Avalanche C-Chain
        - Network: avalanche

        **Payment Flow:**
        1. POST without payment → 402 response with renewal fee
        2. Sign payment with wallet
        3. POST with x402 headers → policy extended

      tags: [policies]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenewPolicyRequest'
            examples:
              renew_24h:
                summary: Extend policy by 24 hours
                value:
                  policy_id: "123e4567-e89b-12d3-a456-426614174000"
                  extend_hours: 24
      responses:
        '200':
          description: Policy renewed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RenewPolicyResponse'
        '402':
          description: Payment Required
          headers:
            X-Payment-Required:
              schema:
                type: string
              description: x402 payment details for renewal fee
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentRequired'
        '400':
          description: Invalid request or policy expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Policy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /verify:
    post:
      summary: Verify Zero-Knowledge Proof
      description: |
        Public endpoint to verify a zkEngine proof. Anyone can verify proofs
        without accessing private policy data.

        This enables:
        - Third-party auditing
        - Proof sharing and verification
        - Transparent fraud detection

      tags: [proofs]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyProofRequest'
      responses:
        '200':
          description: Proof verification result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyProofResponse'
        '400':
          description: Invalid proof data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /proofs/{claim_id}:
    get:
      summary: Get Proof Data
      description: |
        Public endpoint to retrieve complete proof data for a claim.
        Returns the proof, public inputs, and verification status.

      tags: [proofs]
      parameters:
        - name: claim_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Claim ID (UUID)
      responses:
        '200':
          description: Proof data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProofData'
        '404':
          description: Claim not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    ApiInfo:
      type: object
      properties:
        service:
          type: string
          example: "x402 Insurance API"
        version:
          type: string
          example: "1.0.0"
        description:
          type: string
        endpoints:
          type: object
          additionalProperties:
            type: string
        status:
          type: string
          enum: [operational, degraded, maintenance]

    PricingInfo:
      type: object
      properties:
        premium:
          type: object
          properties:
            model:
              type: string
              example: percentage-based
            percentage:
              type: number
              example: 0.01
            percentage_display:
              type: string
              example: "1%"
            calculation:
              type: string
              example: "premium = coverage × percentage"
            currency:
              type: string
              example: "USDC"
            network:
              type: string
              example: "avalanche"
        coverage:
          type: object
          properties:
            min:
              type: number
              example: 0.001
            max:
              type: number
              example: 0.1
            currency:
              type: string
              example: "USDC"
        policy_duration:
          type: object
          properties:
            hours:
              type: integer
              example: 24
            display:
              type: string
              example: "24 hours"
        payment:
          type: object
          properties:
            protocol:
              type: string
              example: "x402"
            network:
              type: string
              example: "avalanche"
            token:
              type: object
              properties:
                symbol:
                  type: string
                  example: "USDC"
                address:
                  type: string
                  example: "0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E"
                decimals:
                  type: integer
                  example: 6

    HealthStatus:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
        zkengine:
          type: string
          enum: [operational, error]
        blockchain:
          type: string
          enum: [connected, disconnected]

    DashboardData:
      type: object
      properties:
        stats:
          type: object
          properties:
            total_coverage:
              type: number
            total_policies:
              type: integer
            claims_paid:
              type: number
        recent_policies:
          type: array
          items:
            $ref: '#/components/schemas/Policy'
        recent_claims:
          type: array
          items:
            $ref: '#/components/schemas/Claim'
        blockchain:
          type: object
          nullable: true
          properties:
            wallet_address:
              type: string
            block_number:
              type: integer
            eth_balance:
              type: string
            usdc_balance:
              type: string
            chain_id:
              type: integer

    CreatePolicyRequest:
      type: object
      required:
        - merchant_url
        - coverage_amount
      properties:
        merchant_url:
          type: string
          format: uri
          description: Merchant API endpoint to protect
          example: "https://api.example.com/data"
        coverage_amount:
          type: number
          minimum: 0.001
          maximum: 0.1
          description: Coverage amount in USDC
          example: 0.01

    PolicyResponse:
      type: object
      properties:
        policy_id:
          type: string
          format: uuid
        agent_address:
          type: string
          pattern: '^0x[a-fA-F0-9]{40}$'
          description: Ethereum address of policy holder
        coverage_amount:
          type: number
        premium:
          type: number
        status:
          type: string
          enum: [active, claimed, expired]
        expires_at:
          type: string
          format: date-time

    Policy:
      allOf:
        - $ref: '#/components/schemas/PolicyResponse'
        - type: object
          properties:
            merchant_url:
              type: string
            merchant_url_hash:
              type: string
            created_at:
              type: string
              format: date-time

    ClaimRequest:
      type: object
      required:
        - policy_id
        - http_response
      properties:
        policy_id:
          type: string
          format: uuid
        http_response:
          type: object
          required:
            - status
            - body
          properties:
            status:
              type: integer
              description: HTTP status code
              example: 503
            body:
              type: string
              description: Response body (empty for fraud)
              example: ""
            headers:
              type: object
              additionalProperties:
                type: string
              description: HTTP headers
              example:
                server: "nginx"

    ClaimResponse:
      type: object
      properties:
        claim_id:
          type: string
          format: uuid
        policy_id:
          type: string
          format: uuid
        proof:
          type: string
          description: Zero-knowledge proof (hex)
          pattern: '^0x[a-fA-F0-9]+$'
        public_inputs:
          type: array
          items:
            type: integer
          description: |
            Public inputs to the proof:
            [0]: is_fraud (1 = yes, 0 = no)
            [1]: http_status
            [2]: body_length
            [3]: suggested_payout
        payout_amount:
          type: number
          description: Actual payout in USDC
        refund_tx_hash:
          type: string
          pattern: '^0x[a-fA-F0-9]{64}$'
          description: Blockchain transaction hash
        status:
          type: string
          enum: [paid, pending, rejected]
        proof_url:
          type: string
          description: URL to retrieve full proof data

    AsyncClaimResponse:
      type: object
      properties:
        claim_id:
          type: string
          format: uuid
          description: Claim ID for polling status
        status:
          type: string
          enum: [processing]
          description: Initial status (always "processing")
        poll_url:
          type: string
          description: URL to poll for claim status
          example: "/claims/123e4567-e89b-12d3-a456-426614174000"
        estimated_completion_seconds:
          type: integer
          description: Estimated time to completion
          example: 20

    ClaimStatusResponse:
      type: object
      properties:
        claim_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [processing, paid, failed]
          description: Current claim status
        payout_amount:
          type: number
          nullable: true
          description: Payout amount (null if still processing)
        refund_tx_hash:
          type: string
          nullable: true
          pattern: '^0x[a-fA-F0-9]{64}$'
          description: Transaction hash (null if still processing)
        error:
          type: string
          nullable: true
          description: Error message (only if status is "failed")
        proof:
          type: string
          nullable: true
          description: Zero-knowledge proof (available when paid)
        public_inputs:
          type: array
          nullable: true
          items:
            type: integer
          description: Public inputs (available when paid)

    PoliciesResponse:
      type: object
      properties:
        wallet:
          type: string
          pattern: '^0x[a-fA-F0-9]{40}$'
          description: Queried wallet address
        total_policies:
          type: integer
          description: Total number of policies for this wallet
        active_policies:
          type: array
          items:
            $ref: '#/components/schemas/Policy'
          description: Currently active policies
        claimed_policies:
          type: array
          items:
            $ref: '#/components/schemas/Policy'
          description: Policies that have been claimed
        expired_policies:
          type: array
          items:
            $ref: '#/components/schemas/Policy'
          description: Expired policies

    RenewPolicyRequest:
      type: object
      required:
        - policy_id
        - extend_hours
      properties:
        policy_id:
          type: string
          format: uuid
          description: ID of the policy to renew
        extend_hours:
          type: integer
          minimum: 1
          maximum: 168
          description: Number of hours to extend (1-168 = 7 days)
          example: 24

    RenewPolicyResponse:
      type: object
      properties:
        policy_id:
          type: string
          format: uuid
        old_expires_at:
          type: string
          format: date-time
          description: Previous expiration time
        new_expires_at:
          type: string
          format: date-time
          description: New expiration time after renewal
        extend_hours:
          type: integer
          description: Number of hours extended
        renewal_fee:
          type: number
          description: Pro-rated renewal fee paid
        renewal_count:
          type: integer
          description: Total number of times this policy has been renewed
        total_renewal_fees:
          type: number
          description: Total renewal fees paid for this policy
        status:
          type: string
          enum: [active]

    Claim:
      allOf:
        - $ref: '#/components/schemas/ClaimResponse'
        - type: object
          properties:
            proof_generation_time_ms:
              type: number
            verification_result:
              type: boolean
            http_status:
              type: integer
            http_body_hash:
              type: string
            http_headers:
              type: object
            recipient_address:
              type: string
            created_at:
              type: string
              format: date-time
            paid_at:
              type: string
              format: date-time

    VerifyProofRequest:
      type: object
      required:
        - proof
        - public_inputs
      properties:
        proof:
          type: string
          pattern: '^0x[a-fA-F0-9]+$'
        public_inputs:
          type: array
          items:
            type: integer
          minItems: 4
          maxItems: 4

    VerifyProofResponse:
      type: object
      properties:
        valid:
          type: boolean
        public_inputs:
          type: array
          items:
            type: integer
        fraud_detected:
          type: boolean
        payout_amount:
          type: number

    ProofData:
      type: object
      properties:
        claim_id:
          type: string
          format: uuid
        proof:
          type: string
        public_inputs:
          type: array
          items:
            type: integer
        http_status:
          type: integer
        http_body_hash:
          type: string
        http_headers:
          type: object
        verification_result:
          type: boolean
        payout_amount:
          type: number
        refund_tx_hash:
          type: string
        recipient_address:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        paid_at:
          type: string
          format: date-time

    PaymentRequired:
      type: object
      properties:
        error:
          type: string
          example: "Payment required"
        payment:
          type: object
          properties:
            amount:
              type: string
              description: Amount in smallest units (USDC has 6 decimals)
              example: "1000"
            asset:
              type: object
              properties:
                address:
                  type: string
                  example: "0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E"
                decimals:
                  type: integer
                  example: 6
                symbol:
                  type: string
                  example: "USDC"
            pay_to:
              type: string
              description: Backend wallet address
            network:
              type: string
              example: "avalanche"

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
